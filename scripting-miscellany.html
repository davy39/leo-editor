<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>A Miscellany of Leo Scripting &mdash; Leo Doc</title>
    
    <link rel="stylesheet" href="_static/leo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '5.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="top" title="Leo Doc" href="index.html" />
    <link rel="up" title="Advanced Topics" href="intermediatetopics.html" />
    <link rel="next" title="Exploring Leo’s Code Base" href="theory.html" />
    <link rel="prev" title="Using @shadow" href="atShadow.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="theory.html" title="Exploring Leo’s Code Base"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="atShadow.html" title="Using @shadow"
             accesskey="P">previous</a> |</li>
        <li><a href="contents.html">Leo Doc</a> &raquo;</li>
          <li><a href="intermediatetopics.html" accesskey="U">Advanced Topics</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="a-miscellany-of-leo-scripting">
<h1><a class="toc-backref" href="#id1">A Miscellany of Leo Scripting</a><a class="headerlink" href="#a-miscellany-of-leo-scripting" title="Permalink to this headline">¶</a></h1>
<p>This chapter covers miscellaneous topics related to Leo scripts.</p>
<p>You might call this a FAQ for scripts...</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#a-miscellany-of-leo-scripting" id="id1">A Miscellany of Leo Scripting</a><ul>
<li><a class="reference internal" href="#creating-minimal-outlines" id="id2">Creating minimal outlines</a></li>
<li><a class="reference internal" href="#creating-qt-windows-from-leo-scripts" id="id3">Creating Qt Windows from Leo scripts</a></li>
<li><a class="reference internal" href="#g-app-gui-run-methods-run-dialogs" id="id4">g.app.gui.run* methods run dialogs</a></li>
<li><a class="reference internal" href="#getting-commander-preferences" id="id5">Getting commander preferences</a></li>
<li><a class="reference internal" href="#getting-configuration-settings" id="id6">Getting configuration settings</a></li>
<li><a class="reference internal" href="#getting-interactive-input-from-scripts" id="id7">Getting interactive input from scripts</a></li>
<li><a class="reference internal" href="#inserting-and-deleting-icons" id="id8">Inserting and deleting icons</a></li>
<li><a class="reference internal" href="#invoking-commands-from-scripts" id="id9">Invoking commands from scripts</a></li>
<li><a class="reference internal" href="#making-operations-undoable" id="id10">Making operations undoable</a></li>
<li><a class="reference internal" href="#modifying-plugins-with-script-scripts" id="id11">Modifying plugins with &#64;script scripts</a></li>
<li><a class="reference internal" href="#modifying-the-body-pane-directly" id="id12">Modifying the body pane directly</a></li>
<li><a class="reference internal" href="#recovering-vnodes" id="id13">Recovering vnodes</a></li>
<li><a class="reference internal" href="#retaining-pointers-to-qt-windows" id="id14">Retaining pointers to Qt windows</a></li>
<li><a class="reference internal" href="#running-leo-in-batch-mode" id="id15">Running Leo in batch mode</a></li>
<li><a class="reference internal" href="#working-with-directives-and-paths" id="id16">Working with directives and paths</a></li>
<li><a class="reference internal" href="#writing-g-es-output-to-other-tabs" id="id17">Writing g.es output to other tabs</a></li>
<li><a class="reference internal" href="#button-example" id="id18">&#64;button example</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="creating-minimal-outlines">
<h2><a class="toc-backref" href="#id2">Creating minimal outlines</a><a class="headerlink" href="#creating-minimal-outlines" title="Permalink to this headline">¶</a></h2>
<p>The following script will create a minimal Leo outline:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
    <span class="c"># Create a visible frame.</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># Create an invisible frame.</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nullGui</span><span class="p">)</span>

<span class="n">c2</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">createFirstTreeNode</span><span class="p">()</span>
<span class="n">c2</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

<span class="c"># Test that the script works.</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c2</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-qt-windows-from-leo-scripts">
<h2><a class="toc-backref" href="#id3">Creating Qt Windows from Leo scripts</a><a class="headerlink" href="#creating-qt-windows-from-leo-scripts" title="Permalink to this headline">¶</a></h2>
<p>The following puts up a test window when run as a Leo script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtGui</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QWidget</span><span class="p">()</span>
<span class="n">w</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s">&#39;Simple test&#39;</span><span class="p">)</span>
<span class="n">w</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">my_test</span> <span class="o">=</span> <span class="n">w</span> <span class="c"># &lt;-- Keep a reference to the window!</span>
</pre></div>
</div>
<p><strong>Important</strong>: Something like the last line is essential. Without it, the window
would immediately disappear after being created.  The assignment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">my_test</span> <span class="o">=</span> <span class="n">w</span>
</pre></div>
</div>
<p>creates a permanent reference to the window so the window won&#8217;t be garbage
collected after the Leo script exits.</p>
</div>
<div class="section" id="g-app-gui-run-methods-run-dialogs">
<h2><a class="toc-backref" href="#id4">g.app.gui.run* methods run dialogs</a><a class="headerlink" href="#g-app-gui-run-methods-run-dialogs" title="Permalink to this headline">¶</a></h2>
<p>Scripts can invoke various dialogs using the following methods of the
g.app.gui object.</p>
<p>Here is a partial list. Use typing completion to get the full list:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskOkCancelNumberDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskOkCancelStringDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskOkDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s">&#39;Ok&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoCancelDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">yesMessage</span><span class="o">=</span><span class="s">&#39;Yes&#39;</span><span class="p">,</span><span class="n">noMessage</span><span class="o">=</span><span class="s">&#39;No&#39;</span><span class="p">,</span><span class="n">defaultButton</span><span class="o">=</span><span class="s">&#39;Yes&#39;</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>The values returned are in (&#8216;ok&#8217;,&#8217;yes&#8217;,&#8217;no&#8217;,&#8217;cancel&#8217;), as indicated by the
method names. Some dialogs also return strings or numbers, again as indicated by
their names.</p>
<p>Scripts can run File Open and Save dialogs with these methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runOpenFileDialog</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">filetypes</span><span class="p">,</span><span class="n">defaultextension</span><span class="p">,</span><span class="n">multiple</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span><span class="n">initialfile</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">filetypes</span><span class="p">,</span><span class="n">defaultextension</span><span class="p">)</span>
</pre></div>
</div>
<p>For details about how to use these file dialogs, look for examples in Leo&#8217;s own
source code. The runOpenFileDialog returns a list of file names.</p>
</div>
<div class="section" id="getting-commander-preferences">
<h2><a class="toc-backref" href="#id5">Getting commander preferences</a><a class="headerlink" href="#getting-commander-preferences" title="Permalink to this headline">¶</a></h2>
<p>Each commander sets ivars corresponding to settings.</p>
<p>Scripts can get the following ivars of the Commands class:</p>
<div class="highlight-python"><div class="highlight"><pre>ivars = (
    &#39;output_doc_flag&#39;,
    &#39;page_width&#39;,
    &#39;page_width&#39;,
    &#39;tab_width&#39;,
    &#39;target_language&#39;,
    &#39;use_header_flag&#39;,
)
print(&quot;Prefs ivars...\n&quot;,color=&quot;purple&quot;)
for ivar in ivars:
    print(getattr(c,ivar))
</pre></div>
</div>
<p>If your script sets c.tab_width it should call f.setTabWidth to redraw the
screen:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>    <span class="c"># Change this and see what happens.</span>
<span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setTabWidth</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-configuration-settings">
<h2><a class="toc-backref" href="#id6">Getting configuration settings</a><a class="headerlink" href="#getting-configuration-settings" title="Permalink to this headline">¶</a></h2>
<p>Settings may be different for each commander.</p>
<p>The c.config class has the following getters.</p>
<ul class="simple">
<li>c.config.getBool(settingName,default=None)</li>
<li>c.config.getColor(settingName)</li>
<li>c.config.getDirectory(settingName)</li>
<li>c.config.getFloat(settingName)</li>
<li>c.config.getInt(settingName)</li>
<li>c.config.getLanguage(settingName)</li>
<li>c.config.getRatio(settingName)</li>
<li>c.config.getShortcut(settingName)</li>
<li>c.config.getString(settingName)</li>
</ul>
<p>These methods return None if no setting exists.</p>
<p>The getBool &#8216;default&#8217; argument to getBool specifies the value to be
returned if the setting does not exist.</p>
</div>
<div class="section" id="getting-interactive-input-from-scripts">
<h2><a class="toc-backref" href="#id7">Getting interactive input from scripts</a><a class="headerlink" href="#getting-interactive-input-from-scripts" title="Permalink to this headline">¶</a></h2>
<p>The following code can be run from a script to get input from the user using the minibuffer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">getInput</span> <span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

   <span class="n">stateName</span> <span class="o">=</span> <span class="s">&#39;get-input&#39;</span>
   <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
   <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">stateName</span><span class="p">)</span>

   <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
       <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&#39;Input: &#39;</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
       <span class="n">k</span><span class="o">.</span><span class="n">getArg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">stateName</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">getInput</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
       <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;input: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

<span class="n">getInput</span><span class="p">()</span>
</pre></div>
</div>
<p>Let&#8217;s look at this in detail.  The lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stateName</span> <span class="o">=</span> <span class="s">&#39;get-input&#39;</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">stateName</span><span class="p">)</span>
</pre></div>
</div>
<p>define a state <em>name</em>, &#8216;get-input&#8217;, unique to this code.
k.getState returns the present state (an int) associated with this state.</p>
<p>When getInput() is first called, the state returned by k.getState will be 0,
so the following lines are executed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&#39;Input: &#39;</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">k</span><span class="o">.</span><span class="n">getArg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">stateName</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">getInput</span><span class="p">)</span>
</pre></div>
</div>
<p>These lines put a protected label in the minibuffer:
the user can&#8217;t delete the label by backspacing.
getArg, and the rest of Leo&#8217;s key handling code, take care of the extremely
complex details of handling key strokes in states.
The call to getArg never returns.
Instead, when the user has finished entering the input by typing &lt;Return&gt;
getArg calls getInput so that k.getState will return state 1, the value
passed as the third argument to k.getArg.
The following lines handle state 1:</p>
<div class="highlight-python"><div class="highlight"><pre>else:
    k.clearState()
    g.es_print(&#39;input: %s&#39; % k.arg)
</pre></div>
</div>
<p>k.arg is the value returned by k.getArg.
This example code just prints the value of k.arg and clears the input state.</p>
</div>
<div class="section" id="inserting-and-deleting-icons">
<h2><a class="toc-backref" href="#id8">Inserting and deleting icons</a><a class="headerlink" href="#inserting-and-deleting-icons" title="Permalink to this headline">¶</a></h2>
<p>You can add an icon to the presently selected node with
c.editCommands.insertIconFromFile(path). path is an absolute path or a path
relative to the leo/Icons folder. A relative path is recommended if you plan to
use the icons on machines with different directory structures.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">path</span> <span class="o">=</span> <span class="s">&#39;rt_arrow_disabled.gif&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">insertIconFromFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>Scripts can delete icons from the presently selected node using the following methods:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">deleteFirstIcon</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">deleteLastIcon</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">deleteNodeIcons</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="invoking-commands-from-scripts">
<h2><a class="toc-backref" href="#id9">Invoking commands from scripts</a><a class="headerlink" href="#invoking-commands-from-scripts" title="Permalink to this headline">¶</a></h2>
<p>Leo dispatches commands using c.doCommand,
which calls the &#8220;command1&#8221; and &#8220;command2&#8221; hook routines for the given label.
c.doCommand catches all exceptions thrown by the command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">doCommand</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">markHeadline</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;markheadline&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also call command handlers directly so that hooks will not be called:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">markHeadline</span><span class="p">()</span>
</pre></div>
</div>
<p>You can invoke minibuffer commands by name.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">executeMinibufferCommand</span><span class="p">(</span><span class="s">&#39;open-outline&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>c.keyHandler.funcReturn contains the value returned from the command.
In many cases, as above, this value is simply &#8216;break&#8217;.</p>
</div>
<div class="section" id="making-operations-undoable">
<h2><a class="toc-backref" href="#id10">Making operations undoable</a><a class="headerlink" href="#making-operations-undoable" title="Permalink to this headline">¶</a></h2>
<p>Plugins and scripts should call u.beforeX and u.afterX methods ato
describe the operation that is being performed. <strong>Note</strong>: u is shorthand for
c.undoer. Most u.beforeX methods return undoData that the client
code merely passes to the corresponding u.afterX method. This data contains
the &#8216;before&#8217; snapshot. The u.afterX methods then create a bead containing
both the &#8216;before&#8217; and &#8216;after&#8217; snapshots.</p>
<p>u.beforeChangeGroup and u.afterChangeGroup allow multiple calls to
u.beforeX and u.afterX methods to be treated as a single undoable entry.
See the code for the Replace All, Sort, Promote and Demote
commands for examples. The u.beforeChangeGroup and u.afterChangeGroup
methods substantially reduce the number of u.beforeX and afterX methods
needed.</p>
<p>Plugins and scripts may define their own u.beforeX and afterX methods. Indeed,
u.afterX merely needs to set the bunch.undoHelper and
bunch.redoHelper ivars to the methods used to undo and redo the operation.
See the code for the various u.beforeX and afterX methods for guidance.</p>
<p>p.setDirty and p.setAllAncestorAtFileNodesDirty now return a
dirtyVnodeList that all vnodes that became dirty as the result of an
operation. More than one list may be generated: client code is responsible for
merging lists using the pattern dirtyVnodeList.extend(dirtyVnodeList2)</p>
<p>See the section &lt;&lt; How Leo implements unlimited undo &gt;&gt; in leoUndo.py
for more details. In general, the best way to see how to implement undo is to
see how Leo&#8217;s core calls the u.beforeX and afterX methods.</p>
</div>
<div class="section" id="modifying-plugins-with-script-scripts">
<h2><a class="toc-backref" href="#id11">Modifying plugins with &#64;script scripts</a><a class="headerlink" href="#modifying-plugins-with-script-scripts" title="Permalink to this headline">¶</a></h2>
<p>The mod_scripting plugin runs &#64;scripts before plugin initiation is complete.
Thus, such scripts can not directly modify plugins. Instead, a script can create
an event handler for the after-create-leo-frame that will modify the plugin.</p>
<p>For example, the following modifies the cleo.py plugin after Leo has completed loading it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">prikey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getat</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s">&#39;priority&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">pa</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">pa</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">pa</span>

<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">leo.core</span> <span class="kn">import</span> <span class="n">leoPlugins</span>

<span class="k">def</span> <span class="nf">on_create</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">cleo</span><span class="o">.</span><span class="n">prikey</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="n">prikey</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">cleo</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">cleo</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>

<span class="n">leoPlugins</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="s">&quot;after-create-leo-frame&quot;</span><span class="p">,</span><span class="n">on_create</span><span class="p">)</span>
</pre></div>
</div>
<p>Attempting to modify c.cleo.prikey immediately in the &#64;script gives an
AttributeError as c has no .cleo when the &#64;script is executed. Deferring it by
using registerHandler() avoids the problem.</p>
</div>
<div class="section" id="modifying-the-body-pane-directly">
<h2><a class="toc-backref" href="#id12">Modifying the body pane directly</a><a class="headerlink" href="#modifying-the-body-pane-directly" title="Permalink to this headline">¶</a></h2>
<p><strong>Important</strong>: The changes you make below <strong>will not persist</strong> unless your
script calls c.frame.body.onBodyChanged after making those changes. This
method has the following signature:</p>
<div class="highlight-python"><div class="highlight"><pre>def onBodyChanged (self,undoType,oldSel=None,oldText=None,oldYview=None):
</pre></div>
</div>
<p>Let:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">wrapper</span> <span class="c"># Leo&#39;s body pane.</span>
</pre></div>
</div>
<p>Scripts can get or change the context of the body as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">w</span><span class="o">.</span><span class="n">appendText</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>                     <span class="c"># Append s to end of body text.</span>
<span class="n">w</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>                  <span class="c"># Delete characters from i to j.</span>
<span class="n">w</span><span class="o">.</span><span class="n">deleteTextSelection</span><span class="p">()</span>             <span class="c"># Delete the selected text, if any.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>                 <span class="c"># Return the text from i to j.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span>                    <span class="c"># Return the entire body text.</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>              <span class="c"># Return the location of the cursor.</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectedText</span><span class="p">()</span>             <span class="c"># Return the selected text, if any.</span>
<span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span> <span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># Return the range of selected text.</span>
<span class="n">w</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>                    <span class="c"># Replace the text from i to j by s.</span>
<span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>                     <span class="c"># Set the entire body text to s.</span>
<span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c"># Select the text.</span>
</pre></div>
</div>
<p><strong>Notes</strong>:</p>
<ul class="simple">
<li>These are only the most commonly-used methods.
For more information, consult Leo&#8217;s source code.</li>
<li>i and j are zero-based indices into the the text. When j is not
specified, it defaults to i. When the sort parameter is in effect,
getSelectionRange ensures i &lt;= j.</li>
<li>color is a Tk color name, even when using the Gt gui.</li>
</ul>
</div>
<div class="section" id="recovering-vnodes">
<h2><a class="toc-backref" href="#id13">Recovering vnodes</a><a class="headerlink" href="#recovering-vnodes" title="Permalink to this headline">¶</a></h2>
<p>Positions become invalid whenever the outline changes.</p>
<p>This script finds a position p2 having the same vnode as an invalid
position p:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="c"># found</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;position no longer exists&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="retaining-pointers-to-qt-windows">
<h2><a class="toc-backref" href="#id14">Retaining pointers to Qt windows</a><a class="headerlink" href="#retaining-pointers-to-qt-windows" title="Permalink to this headline">¶</a></h2>
<p>The following script won&#8217;t work as intended:</p>
<blockquote>
<div>from PyQt4 import QtGui
w = QtGui.QWidget()
w.resize(250, 150)
w.move(300, 300)
w.setWindowTitle(&#8216;Simple test&#8217;)
w.show()</div></blockquote>
<p>When the script exits the sole reference to the window, w, ceases to
exist, so the window is destroyed (garbage collected). To keep the window
open, add the following code as the last line to keep the reference alive:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">scriptsDict</span><span class="p">[</span><span class="s">&#39;my-script_w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
</pre></div>
</div>
<p>Note that this reference will persist until the next time you run the
execute-script. If you want something even more permanent, you can do
something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">my_script_w</span> <span class="o">=</span> <span class="n">w</span>
</pre></div>
</div>
</div>
<div class="section" id="running-leo-in-batch-mode">
<h2><a class="toc-backref" href="#id15">Running Leo in batch mode</a><a class="headerlink" href="#running-leo-in-batch-mode" title="Permalink to this headline">¶</a></h2>
<p>On startup, Leo looks for two arguments of the form:</p>
<div class="highlight-python"><div class="highlight"><pre>--script scriptFile
</pre></div>
</div>
<p>If found, Leo enters batch mode. In batch mode Leo does not show any windows.
Leo assumes the scriptFile contains a Python script and executes the contents of
that file using Leo&#8217;s Execute Script command. By default, Leo sends all
output to the console window. Scripts in the scriptFile may disable or enable
this output by calling app.log.disable or app.log.enable</p>
<p>Scripts in the scriptFile may execute any of Leo&#8217;s commands except the Edit Body
and Edit Headline commands. Those commands require interaction with the user.
For example, the following batch script reads a Leo file and prints all the
headlines in that file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;test&#39;</span><span class="p">,</span><span class="s">&#39;test.leo&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="n">path</span>

<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span> <span class="c"># disable reading messages while opening the file</span>
<span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span> <span class="c"># re-enable the log.</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c2</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="s">&quot;utf-8&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="working-with-directives-and-paths">
<h2><a class="toc-backref" href="#id16">Working with directives and paths</a><a class="headerlink" href="#working-with-directives-and-paths" title="Permalink to this headline">¶</a></h2>
<p>Scripts can easily determine what directives are in effect at a particular
position in an outline. c.scanAllDirectives(p) returns a Python dictionary whose
keys are directive names and whose values are the value in effect at position p.
For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">dictToString</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
</pre></div>
</div>
<p>In particular, d.get(&#8216;path&#8217;) returns the full, absolute path created by all
&#64;path directives that are in ancestors of node p. If p is any kind of &#64;file node
(including &#64;file, &#64;auto, &#64;nosent, &#64;shadow, etc.), the following script will
print the full path to the created file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
<span class="k">if</span> <span class="n">name</span><span class="p">:</span>
   <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
   <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-g-es-output-to-other-tabs">
<h2><a class="toc-backref" href="#id17">Writing g.es output to other tabs</a><a class="headerlink" href="#writing-g-es-output-to-other-tabs" title="Permalink to this headline">¶</a></h2>
<p>g.es can send it&#8217;s output to tabs other than the log tab:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">selectTab</span><span class="p">(</span><span class="s">&#39;Test&#39;</span><span class="p">)</span>
    <span class="c"># Create Test or make it visible.</span>

<span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;Test&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="s">&#39;Test&#39;</span><span class="p">)</span>
    <span class="c"># Write to the test tab.</span>
</pre></div>
</div>
<p>Plugins and scripts may call the c.frame.canvas.createCanvas method to create a
log tab containing a graphics widget. Here is an example script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">log</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;my-canvas&#39;</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">canvasDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">createCanvas</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="s">&#39;yellow&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">selectTab</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="button-example">
<h2><a class="toc-backref" href="#id18">&#64;button example</a><a class="headerlink" href="#button-example" title="Permalink to this headline">¶</a></h2>
<p>The .leo files in Leo&#8217;s distribution contain many &#64;button nodes (many
disabled), that do repetitive chores. Here is one, &#64;button
promote-child-bodies, from LeoDocs.leo:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&#39;&#39;&#39;Copy the body text of all children to the parent&#39;s body text.&#39;&#39;&#39;</span>

<span class="c"># Great for creating what&#39;s new nodes.</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">beforeChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">- </span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">- </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
<span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">afterChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;promote-child-bodies&#39;</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>This creates a fully undoable promote-child-bodies command.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="contents.html">
              <img class="logo" src="_static/Leo4-80-border.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">A Miscellany of Leo Scripting</a><ul>
<li><a class="reference internal" href="#creating-minimal-outlines">Creating minimal outlines</a></li>
<li><a class="reference internal" href="#creating-qt-windows-from-leo-scripts">Creating Qt Windows from Leo scripts</a></li>
<li><a class="reference internal" href="#g-app-gui-run-methods-run-dialogs">g.app.gui.run* methods run dialogs</a></li>
<li><a class="reference internal" href="#getting-commander-preferences">Getting commander preferences</a></li>
<li><a class="reference internal" href="#getting-configuration-settings">Getting configuration settings</a></li>
<li><a class="reference internal" href="#getting-interactive-input-from-scripts">Getting interactive input from scripts</a></li>
<li><a class="reference internal" href="#inserting-and-deleting-icons">Inserting and deleting icons</a></li>
<li><a class="reference internal" href="#invoking-commands-from-scripts">Invoking commands from scripts</a></li>
<li><a class="reference internal" href="#making-operations-undoable">Making operations undoable</a></li>
<li><a class="reference internal" href="#modifying-plugins-with-script-scripts">Modifying plugins with &#64;script scripts</a></li>
<li><a class="reference internal" href="#modifying-the-body-pane-directly">Modifying the body pane directly</a></li>
<li><a class="reference internal" href="#recovering-vnodes">Recovering vnodes</a></li>
<li><a class="reference internal" href="#retaining-pointers-to-qt-windows">Retaining pointers to Qt windows</a></li>
<li><a class="reference internal" href="#running-leo-in-batch-mode">Running Leo in batch mode</a></li>
<li><a class="reference internal" href="#working-with-directives-and-paths">Working with directives and paths</a></li>
<li><a class="reference internal" href="#writing-g-es-output-to-other-tabs">Writing g.es output to other tabs</a></li>
<li><a class="reference internal" href="#button-example">&#64;button example</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="theory.html" title="Exploring Leo’s Code Base"
             >next</a> |</li>
        <li class="right" >
          <a href="atShadow.html" title="Using @shadow"
             >previous</a> |</li>
        <li><a href="contents.html">Leo Doc</a> &raquo;</li>
          <li><a href="intermediatetopics.html" >Advanced Topics</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Edward K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>